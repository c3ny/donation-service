# JWT Integration with Users-Service - Summary

## âœ… Configuration Complete

The donation-service has been configured to **validate** JWT tokens generated by the users-service (port 3002).

## ğŸ”‘ Key Changes

### 1. JWT Strategy Updated

**File**: `src/infrastructure/auth/jwt.strategy.ts`

- Updated JWT payload structure to match users-service:
  - Changed from `sub` â†’ `id`
  - Added `personType` field (DONOR | COMPANY)
  - Returns `userId`, `email`, and `personType` to request

**Token Payload from Users-Service**:

```json
{
  "id": "50f05b0c-5ce0-4920-9960-11f733f713a7",
  "email": "user@example.com",
  "personType": "DONOR",
  "iat": 1623456789
}
```

## ğŸ”„ Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1. Login    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    2. Returns JWT
â”‚   Frontend   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Users-Serviceâ”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚                â”‚  (Port 3002) â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
       â”‚                                                           â”‚
       â”‚ 3. Use JWT in requests                                   â”‚
       â”‚                                                           â”‚
       â–¼                                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    4. Validate  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  Donation    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Same JWT_SECRETâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Service     â”‚    JWT Token    â”‚  in both servicesâ”‚
â”‚  (Port 8080) â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš™ï¸ Environment Setup

### Critical: Same Secret Required

Both services **must use the same** `JWT_SECRET`:

**users-service/.env**:

```env
JWT_SECRET=your-super-secret-jwt-key-change-in-production
```

**donation-service/.env**:

```env
JWT_SECRET=your-super-secret-jwt-key-change-in-production
```

## ğŸ§ª Testing the Integration

### Step 1: Start Both Services

```bash
# Terminal 1 - Users Service
cd users-service
npm run start:dev  # Port 3002

# Terminal 2 - Donation Service
cd donation-service
npm run start:dev  # Port 8080
```

### Step 2: Get JWT Token from Users-Service

```bash
# Login to users-service
curl -X POST http://localhost:3002/users/authenticate \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "Test123!"
  }'
```

**Response**:

```json
{
  "user": {
    "id": "abc-123-def-456",
    "email": "test@example.com",
    "personType": "DONOR"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImFiYy0xMjMtZGVmLTQ1NiIsImVtYWlsIjoidGVzdEBleGFtcGxlLmNvbSIsInBlcnNvblR5cGUiOiJET05PUiIsImlhdCI6MTYyMzQ1Njc4OX0.xyz..."
}
```

### Step 3: Use Token in Donation Service

```bash
# Copy the token from step 2 and use it here
export TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Create a donation (protected endpoint)
curl -X POST http://localhost:8080/donations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "status": "PENDING",
    "content": "Need O+ blood urgently",
    "startDate": "2025-10-25T10:00:00.000Z",
    "bloodType": "O+",
    "location": {
      "latitude": -23.5505,
      "longitude": -46.6333
    },
    "userId": "abc-123-def-456"
  }'
```

## âœ… Expected Behavior

### With Valid Token

- âœ… `POST /donations` - Creates donation successfully
- âœ… `PUT /donations/:id/status` - Updates status successfully
- âœ… `DELETE /donations/:id` - Deletes successfully

### Without Token

```json
{
  "statusCode": 401,
  "message": "Unauthorized"
}
```

### With Invalid/Expired Token

```json
{
  "statusCode": 401,
  "message": "Unauthorized"
}
```

### With Mismatched JWT_SECRET

```json
{
  "statusCode": 401,
  "message": "Unauthorized"
}
```

## ğŸ” Debugging

### Token Validation Fails

**Check 1: Verify JWT_SECRET Match**

```bash
# In users-service
echo $JWT_SECRET

# In donation-service
echo $JWT_SECRET

# They must be identical!
```

**Check 2: Decode Token**
Visit https://jwt.io and paste your token to see the payload. Verify it contains:

- `id` (not `sub`)
- `email`
- `personType`

**Check 3: Check Token Expiration**
Tokens from users-service may have an expiration. If expired, login again to get a fresh token.

## ğŸ“‹ Protected Endpoints

| Endpoint                    | Auth Required | Generates Token | Validates Token |
| --------------------------- | ------------- | --------------- | --------------- |
| `POST /users/authenticate`  | âŒ No         | âœ… Yes          | -               |
| `POST /donations`           | âœ… Yes        | -               | âœ… Yes          |
| `PUT /donations/:id/status` | âœ… Yes        | -               | âœ… Yes          |
| `DELETE /donations/:id`     | âœ… Yes        | -               | âœ… Yes          |

## ğŸ“š Documentation Files

1. **API_DOCUMENTATION.md** - Complete API reference with users-service integration
2. **AUTH_SETUP.md** - Detailed setup and testing guide
3. **AUTHENTICATION_SUMMARY.md** - Implementation details
4. **QUICK_START_JWT.md** - Quick reference guide
5. **INTEGRATION_SUMMARY.md** - This file

## ğŸš€ Next Steps

### For Frontend Developers

1. **Login Flow**: Use users-service for authentication
2. **Store Token**: Save JWT token after login (localStorage/cookies)
3. **Pass Token**: Include in Authorization header for protected donation endpoints
4. **Handle 401**: Redirect to login when token expires

### Example Next.js Integration

```typescript
// 1. Login and get token
const loginResponse = await fetch('http://localhost:3002/users/authenticate', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email, password }),
});
const { token, user } = await loginResponse.json();
localStorage.setItem('jwt_token', token);

// 2. Use token in donation requests
const donationResponse = await fetch('http://localhost:8080/donations', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    Authorization: `Bearer ${localStorage.getItem('jwt_token')}`,
  },
  body: JSON.stringify(donationData),
});
```

## âš ï¸ Important Reminders

1. âœ… JWT_SECRET must be identical in both services
2. âœ… Donation-service only validates tokens (doesn't generate them)
3. âœ… Get tokens from users-service login endpoint
4. âœ… Token contains: `id`, `email`, `personType`
5. âœ… Both services must be running for full functionality

---

**Integration Status**: âœ… Complete  
**Last Updated**: October 17, 2025
